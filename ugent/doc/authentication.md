Setup local authentication
--------------------------

In development mode these authentication

methods are enabled:

* login with username and password using the local web login form.

* login with ORCID

Local web login is enabled in development mode

because it simplifies the effort involved to enter the

application during development. In order to login

with a user do the following from the rails console (`bin/rails console`):

```
user = User.where(email: "nicolas.franck@ugent.be").first
user.password = "mypassword"
user.password_confirmation = user.password
user.save!
```

and use these credentials

Development mode is enabled by setting the environment variable

`RAILS_ENV` to `development`

See `app/views/branded/shared/_access_controls.html.erb` where

this distinction between development mode and production mode

is determined. The upstream version of roadmap does not provide this!

Setup authentication with ORCID
-------------------------------

Set the following environment variables:

* `ORCID_CLIENT_ID`

* `ORCID_CLIENT_SECRET`

These credentials are provided by ORCID via https://orcid.org/developer-tools

Make sure the base redirect uri for dmponline is set to https://dmponline.be/users/auth/orcid

in the developer tools configuration on orcid.org. Otherwise a authentication request will

be rejected.

The credentials used for the production dmponline can use the orcid member api,

and therefore can user attributes that are marked as "trusted parties only".

See also https://info.orcid.org/faq/what-are-the-differences-between-the-public-and-member-apis/

During development, you can use the public orcid sandbox, and disable the member api by setting

`member: false` in config/initializers/devise_ugent.rb`.

Setup authentication with Shibboleth
------------------------------------

Shibboleth authentication is disabled in development mode.

The upstream repo differs from our version as follows:

* it shows a local web login form

* it provides a link "Login with your institution" that links to a "where are you from page" that lists all the managed organisations that have a Shibboleth Identifier (i.e. the "wayfless entitiy") in the database. It assumes that one organisation can only have one such wayfless entity. Which does not work for UGent, that provides two wayfless entities. We list all managed organisations that support shibboleth on the first login page, instead of using that "where are you from page".

* it does NOT provide a link "Login with ORCID". The team [thinks](https://github.com/DMPRoadmap/roadmap/issues/2196#issuecomment-523981339) that orcid authentication does not always return the necessary information that is needed. It does provide the necessary integration to make this possible. They use the integration to link a user's record to ORCID from their profile page (link "Link to ORCID" on the profile page).

We ..

* show all managed organisations that have a wayfless entity. Wayfless entities are stored in table `identifiers` and must be of type shibboleth. The base repository expects one such identifier per organisation, as is shown by the "where-are-you-from" page, but the rest of the software does not enforce or assumes this (and will not hopefully). When an organisation has more than one wayfless entity, we duplicate the link with a different wayfless entity, and show the identifier label. Note that the attribute `Identifier#label` is a local addition, and is generated by migration `db/migrate/20220812124800_ugent_identifier_label.rb`. It can be managed in the [RailsAdmin GUI](https://test.dmponline.be/admin/identifier?model_name=identifier&utf8=%E2%9C%93&f%5Bidentifier_scheme%5D%5B36994%5D%5Bo%5D=is&f%5Bidentifier_scheme%5D%5B36994%5D%5Bv%5D=shibboleth&f%5Bidentifiable_type%5D%5B37122%5D%5Bo%5D=is&f%5Bidentifiable_type%5D%5B37122%5D%5Bv%5D=Org&query=).


In order to setup shibboleth authentication do the following:

* Set environment variable `RAILS_ENV=production`

* install `shibboleth` and setup shibboleth daemon `shibd`. The package already comes with apache integration in file `/usr/lib64/shibboleth/mod_shib_24.so`. The shibboleth daemon is a fastcgi process that runs in the background. Because it is not directly run into Apache, Apache needs to pass all necessary request information to that daemon. Shibd acts as service provider for the backend rails application.

* install Apache

* load shibboleth module by adding a file with contents `LoadModule mod_shib /usr/lib64/shibboleth/mod_shib_24.so` in `/etc/httpd/conf.modules.d`

* configure Apache to protect location `/users/auth/shibboleth/callback` with shibboleth authentication. Calls to that path are processed first by the shibboleth daemon, and only if there is a valid session, the request is passed down to the rails application of roadmap. Apache adds extra headers to the request (like HTTP_SHIB_SESSION_ID or HTTP_SHIB_IDENTITY_PROVIDER), that enables rails to authenticate and authorize the user. The rails application depends on this behaviour. Apparently ALL integrations with shibboleth do. No one writes his/her own shibboleth service provider.

See also `/etc/httpd/conf.d/25-dmponline_443.conf` and `/etc/shibboleth/shibboleth2.xml` on the server
